import { expect, assert } from "chai";
import axios, { AxiosRequestConfig, AxiosResponse } from 'axios'
import * as prep from "./testUtil"
import {testConfig} from './testConfig'



const routeCoords = [[8.640984, 48.281602], [8.640979999999999, 48.28154], [8.64096, 48.28124], [8.640929999999999, 48.28091], [8.64088, 48.28059], [8.64083, 48.2803], [8.64081, 48.28021], [8.6408, 48.280139999999996], [8.64077, 48.27994999999999], [8.64069, 48.27954999999999], [8.64059, 48.279109999999996], [8.640419999999999, 48.278499999999994], [8.64035, 48.27824999999999], [8.64007, 48.277379999999994], [8.63993, 48.276959999999995], [8.63978, 48.276489999999995], [8.63948, 48.2756], [8.6394, 48.275369999999995], [8.639190000000001, 48.274719999999995], [8.639130000000002, 48.274519999999995], [8.638990000000002, 48.27408], [8.638930000000002, 48.2739], [8.638880000000002, 48.273709999999994], [8.638710000000001, 48.27304999999999], [8.638660000000002, 48.272879999999994], [8.638640000000002, 48.2728], [8.638520000000002, 48.27213999999999], [8.638430000000001, 48.27157999999999], [8.638370000000002, 48.27118999999999], [8.638340000000001, 48.27091999999999], [8.63831, 48.27061999999999], [8.63828, 48.26988999999999], [8.63827, 48.269409999999986], [8.63826, 48.26921999999998], [8.63826, 48.26876999999998], [8.63831, 48.26807999999998], [8.63838, 48.26752999999999], [8.63841, 48.267319999999984], [8.63845, 48.26694999999999], [8.63856, 48.26643999999999], [8.63859, 48.26627999999999], [8.6386, 48.26621999999999], [8.638720000000001, 48.26563999999999], [8.63892, 48.26493999999999], [8.639180000000001, 48.26413999999999], [8.639650000000001, 48.26289999999999], [8.639700000000001, 48.26276999999999], [8.639790000000001, 48.26254999999999], [8.6399, 48.26225999999999], [8.64009, 48.26178999999999], [8.64014, 48.26165999999999], [8.64028, 48.261289999999995], [8.64042, 48.26094], [8.64077, 48.26007], [8.64114, 48.25918], [8.64128, 48.25885], [8.64133, 48.25874], [8.64139, 48.258610000000004], [8.641449999999999, 48.258480000000006], [8.641509999999998, 48.258340000000004], [8.641579999999998, 48.25817000000001], [8.641649999999997, 48.25800000000001], [8.641729999999997, 48.25780000000001], [8.642159999999997, 48.25672000000001], [8.642599999999996, 48.25563000000001], [8.643039999999996, 48.25457000000001], [8.643339999999995, 48.25383000000001], [8.643409999999994, 48.25366000000001], [8.643479999999993, 48.25349000000001], [8.643549999999992, 48.25331000000001], [8.643609999999992, 48.253160000000015], [8.643669999999991, 48.25301000000002], [8.643759999999991, 48.25279000000002], [8.643909999999991, 48.25241000000002], [8.644029999999992, 48.252110000000016], [8.644759999999993, 48.25030000000002], [8.644869999999992, 48.25003000000002], [8.644989999999993, 48.249730000000014], [8.645119999999993, 48.24941000000001], [8.645239999999994, 48.24911000000001], [8.645579999999994, 48.24828000000001], [8.645879999999993, 48.24755000000001], [8.645979999999993, 48.24730000000001], [8.646089999999992, 48.24703000000001], [8.646199999999991, 48.24676000000001], [8.646279999999992, 48.24656000000001], [8.646359999999992, 48.24635000000001], [8.646439999999993, 48.24615000000001], [8.646539999999993, 48.245900000000006], [8.646649999999992, 48.24562000000001], [8.646819999999993, 48.24518000000001], [8.646989999999994, 48.24473000000001], [8.647059999999993, 48.24457000000001], [8.647159999999992, 48.24435000000001], [8.647289999999993, 48.24402000000001], [8.647509999999993, 48.243490000000016], [8.647629999999994, 48.24319000000001], [8.647769999999994, 48.24285000000001], [8.648009999999994, 48.24226000000001], [8.648129999999995, 48.24197000000001], [8.648359999999995, 48.24139000000001], [8.648539999999995, 48.24093000000001], [8.648749999999994, 48.240400000000015], [8.648899999999994, 48.24001000000001], [8.648959999999994, 48.239860000000014], [8.649019999999993, 48.23971000000002], [8.649069999999993, 48.23958000000002], [8.649129999999992, 48.23941000000002], [8.649199999999992, 48.23921000000002], [8.64926999999999, 48.23901000000002], [8.64933999999999, 48.23881000000002], [8.64938999999999, 48.238660000000024], [8.649459999999989, 48.23845000000002], [8.649529999999988, 48.23823000000002], [8.649589999999987, 48.23803000000002], [8.649649999999987, 48.237830000000024], [8.649709999999986, 48.237630000000024], [8.649769999999986, 48.237430000000025], [8.649829999999985, 48.23722000000002], [8.649899999999985, 48.236980000000024], [8.649969999999984, 48.23672000000003], [8.650029999999983, 48.23648000000003], [8.650079999999983, 48.23628000000003], [8.650119999999983, 48.23610000000003], [8.650149999999984, 48.23596000000003], [8.650179999999985, 48.235820000000025], [8.650209999999985, 48.23568000000002], [8.650249999999986, 48.235480000000024], [8.650289999999986, 48.235260000000025], [8.650329999999986, 48.235010000000024], [8.650369999999986, 48.23474000000002], [8.650409999999987, 48.23447000000002], [8.650439999999987, 48.23424000000002], [8.650459999999986, 48.23404000000002], [8.650479999999986, 48.23383000000002], [8.650499999999985, 48.23361000000002], [8.650509999999985, 48.23341000000002], [8.650519999999984, 48.23315000000002], [8.650529999999984, 48.23285000000002], [8.650529999999984, 48.23259000000002], [8.650529999999984, 48.232350000000025], [8.650519999999984, 48.232100000000024], [8.650509999999985, 48.23182000000003], [8.650499999999985, 48.23156000000003], [8.650479999999986, 48.23127000000003], [8.650449999999985, 48.23097000000003], [8.650409999999985, 48.230650000000026], [8.650369999999985, 48.23035000000002], [8.650319999999985, 48.23005000000002], [8.650269999999985, 48.22977000000002], [8.650209999999985, 48.22947000000002], [8.650149999999986, 48.229190000000024], [8.650079999999987, 48.228880000000025], [8.649999999999986, 48.228570000000026], [8.649929999999987, 48.228320000000025], [8.649859999999988, 48.22809000000002], [8.649789999999989, 48.22786000000002], [8.64972999999999, 48.22767000000002], [8.64966999999999, 48.22750000000002], [8.64959999999999, 48.22731000000002], [8.649529999999992, 48.22713000000002], [8.649449999999991, 48.226920000000014], [8.64935999999999, 48.22669000000001], [8.649259999999991, 48.22647000000001], [8.64912999999999, 48.22620000000001], [8.64885999999999, 48.225600000000014], [8.64862999999999, 48.22516000000002], [8.64834999999999, 48.22463000000002], [8.64787999999999, 48.22385000000002], [8.64773999999999, 48.22362000000002], [8.64750999999999, 48.22325000000002], [8.64730999999999, 48.222970000000025], [8.647099999999991, 48.22267000000002], [8.646859999999991, 48.22235000000002], [8.646609999999992, 48.22202000000002], [8.646379999999992, 48.22173000000002], [8.646129999999992, 48.22143000000002], [8.645889999999993, 48.22114000000002], [8.645629999999992, 48.22083000000002], [8.645349999999992, 48.22051000000002], [8.645069999999992, 48.22019000000002], [8.644779999999992, 48.219870000000014], [8.644539999999992, 48.21961000000002], [8.644269999999992, 48.21932000000002], [8.644099999999991, 48.21914000000002], [8.64392999999999, 48.21896000000002], [8.64368999999999, 48.21872000000002], [8.643389999999991, 48.218420000000016], [8.64307999999999, 48.21811000000002], [8.642779999999991, 48.217810000000014], [8.642459999999991, 48.217500000000015], [8.642169999999991, 48.217230000000015], [8.641869999999992, 48.21695000000002], [8.641549999999992, 48.21666000000002], [8.641229999999991, 48.21638000000002], [8.64082999999999, 48.21604000000002], [8.640479999999991, 48.21575000000002], [8.640109999999991, 48.21544000000002], [8.639759999999992, 48.21515000000002], [8.639439999999992, 48.214890000000025], [8.639109999999992, 48.21463000000003], [8.638779999999992, 48.21438000000003], [8.638459999999991, 48.214130000000026], [8.638109999999992, 48.21387000000003], [8.637789999999992, 48.21363000000003], [8.637419999999992, 48.21336000000003], [8.637079999999992, 48.21312000000003], [8.636749999999992, 48.21289000000003], [8.636379999999992, 48.21263000000003], [8.636029999999993, 48.212390000000035], [8.635659999999993, 48.21214000000003], [8.635319999999993, 48.211920000000035], [8.635039999999993, 48.211740000000034], [8.634879999999994, 48.21164000000003], [8.634739999999994, 48.21155000000003], [8.634339999999993, 48.21130000000003], [8.633919999999993, 48.21104000000003], [8.633439999999993, 48.21075000000003], [8.633089999999994, 48.21054000000003], [8.632599999999995, 48.21025000000003], [8.632149999999994, 48.20999000000003], [8.631699999999993, 48.20974000000003], [8.631259999999994, 48.209500000000034], [8.630809999999993, 48.209260000000036], [8.630299999999993, 48.208990000000036], [8.629779999999993, 48.208720000000035], [8.628639999999994, 48.208160000000035], [8.627539999999994, 48.20764000000003], [8.627239999999995, 48.20750000000003], [8.626929999999994, 48.20736000000003], [8.626559999999994, 48.20719000000003], [8.626169999999995, 48.207020000000036], [8.625789999999995, 48.206860000000034], [8.625399999999996, 48.20669000000004], [8.624919999999996, 48.20649000000004], [8.624549999999996, 48.20634000000004], [8.624249999999996, 48.20622000000004], [8.623899999999997, 48.206080000000036], [8.622699999999996, 48.20562000000004], [8.622419999999996, 48.20551000000004], [8.622149999999996, 48.205410000000036], [8.621199999999996, 48.205070000000035], [8.620879999999996, 48.204960000000035], [8.620479999999995, 48.20482000000003], [8.620119999999995, 48.20470000000003], [8.619639999999995, 48.20454000000003], [8.619109999999996, 48.20437000000003], [8.618419999999995, 48.204150000000034], [8.617179999999996, 48.203770000000034], [8.616639999999995, 48.20361000000003], [8.616139999999994, 48.203460000000035], [8.615659999999995, 48.20331000000004], [8.615289999999995, 48.20320000000004], [8.614849999999995, 48.20307000000004], [8.614379999999995, 48.20293000000004], [8.613869999999995, 48.20278000000004], [8.613359999999995, 48.20263000000004], [8.612989999999995, 48.20252000000004], [8.612529999999994, 48.20238000000004], [8.611959999999995, 48.20221000000004], [8.611189999999995, 48.20198000000004], [8.610729999999995, 48.20184000000004], [8.610319999999994, 48.20172000000004], [8.609989999999994, 48.201620000000034], [8.609509999999995, 48.20148000000003], [8.609049999999995, 48.20134000000003], [8.608539999999994, 48.20119000000003], [8.608009999999995, 48.20103000000003], [8.607509999999994, 48.20088000000003], [8.606969999999993, 48.20072000000003], [8.606439999999994, 48.20056000000003], [8.605849999999993, 48.20038000000003], [8.605199999999993, 48.20018000000003],
[8.604489999999993, 48.19996000000003], [8.603789999999993, 48.199740000000034], [8.603159999999994, 48.199540000000034], [8.602509999999993, 48.19933000000003], [8.601849999999994, 48.19911000000003], [8.601199999999993, 48.198890000000034], [8.600759999999994, 48.198740000000036], [8.600269999999995, 48.19857000000004], [8.599779999999996, 48.19840000000004], [8.599329999999995, 48.19824000000004], [8.598929999999994, 48.19809000000004], [8.598549999999994, 48.197940000000045], [8.598159999999995, 48.197780000000044], [8.597749999999994, 48.19761000000005], [8.597299999999994, 48.197420000000044], [8.596869999999994, 48.19723000000004], [8.596399999999994, 48.19702000000004], [8.595899999999993, 48.196790000000036], [8.595629999999993, 48.19667000000003], [8.595379999999993, 48.196560000000034], [8.595129999999994, 48.19644000000003], [8.594509999999994, 48.19615000000003], [8.593229999999995, 48.195510000000034], [8.591979999999994, 48.19485000000003], [8.590759999999994, 48.19417000000003], [8.590119999999994, 48.19379000000003], [8.589809999999993, 48.193600000000025], [8.588869999999993, 48.193020000000026], [8.587759999999992, 48.192300000000024], [8.586719999999993, 48.19158000000002], [8.585929999999992, 48.19099000000002], [8.585329999999992, 48.19054000000002], [8.584929999999991, 48.19022000000002], [8.58432999999999, 48.189740000000015], [8.584179999999991, 48.189610000000016], [8.583739999999992, 48.18924000000002], [8.583169999999992, 48.18875000000002], [8.582829999999992, 48.18844000000002], [8.582239999999992, 48.187910000000024], [8.581689999999991, 48.18739000000002], [8.581159999999992, 48.18688000000002], [8.580659999999991, 48.18636000000002], [8.580309999999992, 48.186010000000024], [8.579949999999991, 48.185610000000025], [8.57954999999999, 48.185160000000025], [8.57894999999999, 48.18448000000002], [8.57837999999999, 48.18376000000002], [8.57794999999999, 48.183210000000024], [8.57752999999999, 48.18266000000003], [8.57701999999999, 48.18192000000003], [8.57664999999999, 48.18135000000002], [8.57641999999999, 48.18097000000002], [8.57617999999999, 48.18060000000003], [8.57583999999999, 48.18004000000003], [8.57575999999999, 48.17991000000003], [8.57561999999999, 48.17967000000003], [8.57541999999999, 48.17930000000003], [8.57533999999999, 48.179150000000035], [8.57528999999999, 48.179060000000035], [8.57519999999999, 48.17891000000004], [8.57499999999999, 48.17853000000004], [8.57480999999999, 48.17815000000004], [8.574609999999991, 48.17770000000004], [8.574539999999992, 48.17755000000004], [8.574249999999992, 48.17712000000004], [8.574169999999992, 48.177000000000035], [8.574079999999991, 48.176890000000036], [8.573969999999992, 48.176780000000036], [8.573859999999993, 48.17670000000004], [8.573749999999993, 48.17664000000004], [8.573619999999993, 48.17659000000004], [8.573489999999993, 48.17656000000004], [8.573379999999993, 48.176550000000034], [8.573249999999993, 48.176550000000034], [8.573159999999993, 48.17656000000004], [8.573039999999992, 48.17659000000004], [8.572949999999992, 48.17662000000004], [8.572849999999992, 48.176670000000044], [8.572759999999992, 48.176740000000045], [8.572699999999992, 48.176810000000046], [8.572649999999992, 48.176900000000046], [8.572619999999992, 48.17700000000005], [8.572609999999992, 48.177080000000046], [8.572619999999992, 48.17720000000005], [8.572659999999992, 48.17736000000005], [8.572719999999991, 48.17756000000005], [8.572839999999992, 48.17791000000005], [8.573119999999992, 48.177880000000044], [8.574029999999992, 48.17778000000004], [8.574459999999991, 48.17772000000004], [8.574609999999991, 48.177700000000044], [8.574779999999992, 48.177680000000045], [8.574979999999991, 48.177660000000046], [8.575449999999991, 48.177610000000044], [8.57560999999999, 48.177520000000044], [8.57571999999999, 48.17745000000004], [8.57582999999999, 48.17736000000004], [8.575929999999989, 48.177230000000044], [8.57586999999999, 48.177010000000045], [8.57577999999999, 48.176740000000045], [8.575749999999989, 48.17666000000005], [8.575709999999988, 48.176560000000045], [8.575649999999989, 48.17646000000004], [8.575459999999989, 48.17635000000004], [8.575319999999989, 48.176270000000045], [8.575129999999989, 48.17623000000005], [8.574959999999988, 48.17622000000004], [8.574759999999989, 48.17626000000004], [8.574619999999989, 48.17634000000004], [8.574499999999988, 48.17645000000004], [8.574449999999988, 48.17658000000004], [8.574449999999988, 48.176730000000035], [8.574449999999988, 48.176930000000034], [8.574779999999988, 48.17768000000003], [8.574999999999989, 48.17811000000003], [8.57521999999999, 48.17857000000003], [8.575429999999988, 48.17897000000003], [8.575559999999989, 48.17920000000003], [8.57567999999999, 48.17941000000003], [8.57596999999999, 48.179910000000035], [8.57636999999999, 48.18061000000004], [8.57651999999999, 48.18084000000004], [8.57670999999999, 48.18113000000004], [8.57684999999999, 48.18136000000004], [8.57713999999999, 48.18179000000004], [8.577479999999989, 48.18226000000004], [8.577759999999989, 48.18264000000004], [8.578039999999989, 48.18302000000004], [8.57843999999999, 48.18355000000004], [8.57889999999999, 48.18412000000004], [8.57925999999999, 48.18456000000004], [8.579629999999991, 48.18500000000004], [8.579939999999992, 48.18536000000004], [8.580109999999992, 48.18555000000004], [8.580439999999992, 48.18590000000004], [8.580949999999993, 48.18644000000004], [8.581399999999993, 48.18689000000004], [8.581919999999993, 48.18742000000004], [8.582349999999993, 48.18782000000004], [8.582799999999994, 48.18823000000004], [8.583379999999993, 48.18875000000004], [8.583899999999993, 48.18920000000004], [8.584409999999993, 48.189630000000044], [8.584669999999994, 48.18983000000004], [8.585073999999993, 48.19014600000004]]


async function createEntities() {

    await prep.deleteAllEntities()

    const entity_very_close = {
      

        "id": "urn:xdatatogo:TrafficRestriction:very_close",
        "type": "TrafficRestriction",

        "name": {
            "type": "Property",
            "value": "very_close"
        },
        "dateValidFrom": {
            "type": "Property",
            "value": {
                "@type": "DateTime",
                "@value": "2021-02-08T06:00:00.000Z"
            }
        },
        "dateValidUntil": {
            "type": "Property",
            "value": {
                "@type": "DateTime",
                "@value": "2021-02-08T06:00:00.000Z"
            }
        },
        "location": {
            "type": "GeoProperty",
            "value": {
                "type": "Point",
                "coordinates": [8.585334873790753, 48.190456519977353]
            }
        },
        "maxSpeed": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleAxleLoad": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleHeight": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleWeight": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleWidth": {
            "type": "Property",
            "value": 123
        }
    }


    const entity_somewhat_close = {
       

        "id": "urn:xdatatogo:TrafficRestriction:somwhat_close",
        "type": "TrafficRestriction",
        "name": {
            "type": "Property",
            "value": "somewhat_close"
        },
        "dateValidFrom": {
            "type": "Property",
            "value": {
                "@type": "DateTime",
                "@value": "2021-02-08T06:00:00.000Z"
            }
        },
        "dateValidUntil": {
            "type": "Property",
            "value": {
                "@type": "DateTime",
                "@value": "2021-02-08T06:00:00.000Z"
            }
        },
        "location": {
            "type": "GeoProperty",
            "value": {
                "type": "Point",
                "coordinates": [8.626806995767446, 48.211859225553688]
            }
        },
        "maxSpeed": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleAxleLoad": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleHeight": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleWeight": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleWidth": {
            "type": "Property",
            "value": 123
        }
    }


    const entity_far = {
       

        "id": "urn:xdatatogo:TrafficRestriction:far",
        "type": "TrafficRestriction",
        "name": {
            "type": "Property",
            "value": "far"
        },
        "dateValidFrom": {
            "type": "Property",
            "value": {
                "@type": "DateTime",
                "@value": "2021-02-08T06:00:00.000Z"
            }
        },
        "dateValidUntil": {
            "type": "Property",
            "value": {
                "@type": "DateTime",
                "@value": "2021-02-08T06:00:00.000Z"
            }
        },
        "location": {
            "type": "GeoProperty",
            "value": {
                "type": "Point",
                "coordinates": [8.791811037383784, 48.127597765534865]
            }
        },
        "maxSpeed": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleAxleLoad": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleHeight": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleWeight": {
            "type": "Property",
            "value": 123
        },
        "maxVehicleWidth": {
            "type": "Property",
            "value": 123
        }
    }


    let config: AxiosRequestConfig = { 
        headers: { "content-type": "application/ld+json" },
        auth: testConfig.auth
    }

  
    // Create obstacle entities:
    await axios.post(testConfig.base_url + "entities/", entity_very_close, config).catch((e) => {
        console.log(e)
    })

    await axios.post(testConfig.base_url + "entities/", entity_somewhat_close, config).catch((e) => {
        console.log(e)
    })

    await axios.post(testConfig.base_url + "entities/", entity_far, config).catch((e) => {
        console.log(e)
    })
}


describe('6.23.3.1 POST /entityOperations/query with GeoQuery', function () {



    beforeEach(async () => {
        await prep.deleteAllEntities()

        await createEntities()
     
    })


    afterEach(async () => {
        await prep.deleteAllEntities()
     

    })



    it("should return the one entity that is closest to the query LineString", async function () {
        const query = {
          
            geoQ: {
                "georel": "near;maxDistance==10",
                "geometry": "LineString",
                "coordinates": routeCoords,
                "geoproperty": "location"
            },
            "type": "Query"
        }

        let config = {
            headers: {            
                "content-type": "application/ld+json"
            },
            auth: testConfig.auth
        }


        let response = await axios.post(testConfig.base_url + "entityOperations/query/", query, config).catch((e) => {
            console.log(e)
        }) as AxiosResponse


        assert(response)

        expect(response.data).instanceOf(Array)
        expect(response.data.length).equals(1)

        expect(response.data[0].id).equals("urn:xdatatogo:TrafficRestriction:very_close")


    })


    it("should return the one entity that is farthest await from the query LineString", async function () {
        const query = {
          
            geoQ: {
                "georel": "near;minDistance==1000",
                "geometry": "LineString",
                "coordinates": routeCoords,
                "geoproperty": "location"
            },
            "type": "Query"
        }

        let config = {
            headers: {
                 "content-type": "application/ld+json"
            },
            auth: testConfig.auth
        }


        let response = await axios.post(testConfig.base_url + "entityOperations/query/", query, config).catch((e) => {
            console.log(e)
        }) as AxiosResponse


        assert(response)

        expect(response.data).instanceOf(Array)
        expect(response.data.length).equals(1)

        expect(response.data[0].id).equals("urn:xdatatogo:TrafficRestriction:far")

    })
});

